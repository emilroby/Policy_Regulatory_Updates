<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSEFI Policy and Regulatory Monitoring Dashboard</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom professional shadow for elements */
        .shadow-pro {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar styles for the policy list containers */
        .policy-card-container {
            max-height: 400px; 
            overflow-y: auto; 
            padding: 0 4px; 
            margin: 0 -4px;
            scroll-behavior: smooth; 
        
            /* FIX 2: Hide Scrollbar (Firefox) */
            scrollbar-width: none; 
        }
        
        /* FIX 2: Hide Scrollbar (WebKit: Chrome, Safari) */
        .policy-card-container::-webkit-scrollbar { 
            display: none; /* WebKit */
            width: 0;
            height: 0;
        }

        /* Original, now unused scrollbar styles are commented out */
        /* .policy-card-container::-webkit-scrollbar-thumb { background-color: #165843; border-radius: 10px; }
        .policy-card-container::-webkit-webkit-scrollbar-track { background: #e0e0e0; } */
        
        /* New style for the real-time clock */
        .real-time-clock {
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* gray-600 */
        }
        
        /* New class for a cleaner, more professional navbar */
        .professional-nav-link {
            padding: 8px 16px;
            text-decoration: none;
            font-weight: 600;
            color: #0F4237; /* Dark green text */
            border-radius: 8px;
            transition: all 0.2s;
            display: block; /* Ensure full clickable area for dropdowns */
        }
        .professional-nav-link:hover {
            background-color: #e6f1ec; /* Very subtle light green background */
            color: #165843; /* Darker green on hover */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* --- DROPDOWN STYLES: ADOPTED FROM SLATE FOR RELIABILITY --- */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            background-color: #f7f7f7; 
            min-width: 220px; 
            border-radius: 0.5rem;
            box-shadow: 0 6px 20px rgba(0, 66, 66, 0.2); 
            border-top: 3px solid #165843;
            margin-top: 0.5rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            text-align: left; /* Ensures flyout links are left-aligned */
        }
        .group:hover .dropdown-menu {
            display: block;
            opacity: 1;
            visibility: visible;
        }
        .dropdown-link {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #374151;
            font-weight: 500;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s, color 0.2s;
        }
        .dropdown-link:last-child {
            border-bottom: none;
        }
        .dropdown-link:hover {
            background-color: #165843; 
            color: white; 
            font-weight: 600;
        }
        /* --- END DROPDOWN STYLES --- */

        /* --- NEW FLYOUT MENU STYLES (Level 3) --- */
        .dropdown-item-group {
            position: relative;
        }
        /* The Flyout Menu Container (Level 3) */
        .dropdown-menu-flyout {
            display: none;
            position: absolute;
            top: 0; 
            left: 100%; 
            z-index: 2000;
            background-color: #f7f7f7; 
            min-width: 240px; 
            border-radius: 0.5rem;
            box-shadow: 0 6px 20px rgba(0, 66, 66, 0.2); 
            border-left: 3px solid #165843;
            margin-left: -1px; /* FIX: Overlap parent slightly to ensure continuous hover */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            text-align: left; 
            list-style: none; 
            padding: 0; 
            overflow-y: auto; /* Allow scrolling for long state lists */
            max-height: 400px;
        }
        /* Show the flyout on hover of the parent item */
        .dropdown-item-group:hover .dropdown-menu-flyout {
            display: block;
            opacity: 1;
            visibility: visible;
        }
        /* Ensure the parent item (Central/State/UT) has a full hover background */
        .dropdown-item-group > .dropdown-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left; /* Overrides center alignment from .dropdown-link */
            width: 100%; /* Ensure full width hover */
        }
        .dropdown-item-group .flyout-link {
            /* Style for the links inside the flyout menu */
            display: block;
            padding: 0.75rem 1rem; /* Increased padding for better target */
            color: #374151;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            border-bottom: 1px solid #e0e0e0; 
            text-align: left;
            width: 100%;
        }
        .dropdown-item-group .flyout-link:hover {
            background-color: #165843; 
            color: white;
        }
        .dropdown-item-group .flyout-link:last-child {
            border-bottom: none;
        }


        /* Enhanced card hover effect */
        .policy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3pßx rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* --- SLATE REFACTOR STYLES --- */
        .fixed-header-nav {
            height: 110px; /* Increased height for two rows */
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            /* Background set to white with slight transparency */
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(10px);
        }
        .header-content-wrapper {
            max-width: 1280px; /* equivalent to container mx-auto */
            width: 100%;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        /* Push the main content down to account for the fixed header */
        .main-content-start {
            /* FIX 1: Increased padding for reliable display of title below header */
            padding-top: 170px; /* Increased padding from 160px */
        }
        .branding-title {
            font-size: 1.8rem; /* Slightly larger for prominence */
            font-weight: 800;
            color: #165843;
            line-height: 1.2;
            white-space: nowrap;
        }
        /* MODIFIED: Combined Title and Clock Layout */
        .title-clock-container {
            /* Full width container for the left side of the fixed header */
            display: flex;
            justify-content: flex-start;
            align-items: center;
            height: 100%;
            gap: 2rem;
            min-width: 50%;
        }
        .datetime-display {
            /* Kept simple, placed on the left of Row 2 */
            font-size: 0.8rem; /* Slightly smaller for clock/date */
            color: #374151;
            font-weight: 500;
            line-height: 1.1;
        }
        
        /* New Hero styles */
        .hero-section {
            padding-top: 170px; /* Match main content start padding */
            padding-bottom: 40px; 
            text-align: center;
            background-color: #f7fbf9; /* Slight off-white background for separation */
            border-bottom: 1px solid #e0eeeb;
        }

        .hero-title {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800;
            color: #0F4237;
            margin-bottom: 0.5rem;
        }

        .hero-tagline {
            font-size: 1.125rem; /* text-lg */
            color: #4b5563;
            max-width: 700px;
            margin: 0 auto;
        }
        
    </style>
</head>
<body>
    <div id="app-root">
        <!-- Dashboard will be rendered here -->
        <div class="min-h-screen bg-white text-[#0F4237] font-sans">
            
            <!-- FIXED NAVIGATION BAR (SLATE STYLE) -->
            <nav class="fixed fixed-header-nav top-0 left-0 right-0">
                <div class="header-content-wrapper flex flex-col h-full">
                    
                    <!-- ROW 1 (TOP): CENTERED TITLE -->
                    <div class="flex justify-center items-center h-1/2 pt-1">
                         <h1 class="branding-title text-3xl">
                            NSEFI Policy and Regulatory Monitoring Dashboard
                        </h1>
                    </div>
                    
                    <!-- ROW 2 (BOTTOM): CLOCK (LEFT) + NAVIGATION LINKS (RIGHT) -->
                    <div class="flex items-center justify-between h-1/2 pb-1">
                        
                        <!-- LEFT: Real-Time Clock -->
                        <div id="real-time-clock" class="datetime-display">
                            Loading Date/Time...
                        </div>
                        
                        <!-- RIGHT: Navigation Links (Buttons) -->
                        <div class="items-center space-x-2 hidden sm:flex">
                            <a href="#" class="professional-nav-link">Home</a>
                            <a href="#" class="professional-nav-link">Representations</a>
                            
                            <!-- Policies Dropdown (Level 1) -->
                            <div class="relative group">
                                <span class="professional-nav-link cursor-pointer flex items-center">
                                    Policies 
                                    <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </span>
                                
                                <!-- Dropdown Menu (Level 2: Central, State, UT) -->
                                <div class="dropdown-menu absolute text-left">
                                    <div class="dropdown-item-group group/flyout">
                                        <a href="#" class="dropdown-link cursor-pointer" id="central-policies-link">
                                            Central
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                        <!-- Flyout Menu (Level 3: Specific Entities) -->
                                        <div class="dropdown-menu-flyout absolute" id="central-policies-flyout">
                                            <!-- Content inserted by JS onload -->
                                        </div>
                                    </div>

                                    <div class="dropdown-item-group group/flyout">
                                        <a href="#" class="dropdown-link cursor-pointer" id="states-policies-link">
                                            States
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                        <div class="dropdown-menu-flyout absolute" id="states-policies-flyout">
                                            <!-- Content inserted by JS onload -->
                                        </div>
                                    </div>
                                    
                                    <div class="dropdown-item-group group/flyout">
                                        <a href="#" class="dropdown-link cursor-pointer" id="uts-policies-link">
                                            UTs
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                        <div class="dropdown-menu-flyout absolute" id="uts-policies-flyout">
                                            <!-- Content inserted by JS onload -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Regulations Dropdown (Level 1) -->
                            <div class="relative group">
                                <span class="professional-nav-link cursor-pointer flex items-center">
                                    Regulations 
                                    <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </span>
                                
                                <!-- Dropdown Menu (Level 2: Central, State, UT) -->
                                <div class="dropdown-menu absolute text-left">
                                    <div class="dropdown-item-group group/flyout">
                                        <a href="#" class="dropdown-link cursor-pointer" id="central-regulations-link">
                                            Central
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                        <div class="dropdown-menu-flyout absolute" id="central-regulations-flyout">
                                            <!-- Content inserted by JS onload -->
                                        </div>
                                    </div>

                                    <div class="dropdown-item-group group/flyout">
                                        <a href="#" class="dropdown-link cursor-pointer" id="states-regulations-link">
                                            States
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                        <div class="dropdown-menu-flyout absolute" id="states-regulations-flyout">
                                            <!-- Content inserted by JS onload -->
                                        </div>
                                    </div>
                                    
                                    <div class="dropdown-item-group group/flyout">
                                        <a href="#" class="dropdown-link cursor-pointer" id="uts-regulations-link">
                                            UTs
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                        <div class="dropdown-menu-flyout absolute" id="uts-regulations-flyout">
                                            <!-- Content inserted by JS onload -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- END FIXED NAVIGATION BAR -->

            <!-- NEW: HERO SECTION -->
            <section class="hero-section">
                <div class="max-w-4xl mx-auto px-4">
                    <h2 class="hero-title">Real-Time Regulatory Intelligence</h2>
                    <p class="hero-tagline">
                        Tracking daily policy and regulatory shifts across Central, State, and UT governments
                        to quantify risk and opportunity in the renewable energy sector.
                    </p>
                </div>
            </section>
            <!-- END HERO SECTION -->


            <!-- MAIN CONTENT AREA - Starts below the fixed header -->
            <main class="p-4 sm:p-8">
                <!-- Dynamic Section Title -->
                <h2 id="month-title" class="text-3xl font-bold text-[#165843] border-l-4 border-[#165843] pl-3 mb-8 mt-12">
                    Latest updates — Loading Month...
                </h2>
                
                <!-- Main Three-Column Data Grid -->
                <div id="policy-grid" class="grid gap-8 lg:grid-cols-3 md:grid-cols-2 grid-cols-1">
                    <!-- Columns rendered by JavaScript -->
                </div>
            </main>
        </div>

        <!-- Policy Detail Modal -->
        <div id="policyModal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50 hidden" onclick="closeModal()">
            <div class="bg-white text-[#0F4237] rounded-xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto transform transition-all duration-300" onclick="event.stopPropagation()">
                <div class="p-6 sm:p-8">
                    <div class="flex justify-between items-start mb-6 border-b border-gray-200 pb-4">
                        <h2 id="modalTitle" class="text-2xl sm:text-3xl font-bold text-[#165843] pr-4"></h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-red-600 p-1 rounded-full bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div id="modalMeta" class="flex flex-wrap items-center text-sm text-gray-600 mb-6 space-x-4"></div>
                    <p id="modalSummary" class="text-gray-700 whitespace-pre-wrap leading-relaxed mb-6"></p>
                    <a id="modalLink" href="#" target="_blank" class="inline-flex items-center px-6 py-2 bg-[#165843] text-white font-bold rounded-lg hover:bg-[#0F4237] transition-colors duration-200 shadow-pro">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        View Original Document
                    </a>
                </div>
            </div>
        </div>

        <!-- Full List Modal for Central/State/UT entities -->
        <div id="fullListModal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-[3000] hidden" onclick="closeFullDropdown()">
            <div class="bg-white text-[#0F4237] rounded-xl shadow-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300" onclick="event.stopPropagation()">
                <div class="p-6 sm:p-8">
                    <div class="flex justify-between items-start mb-6 border-b border-gray-200 pb-4">
                        <h2 id="fullListTitle" class="text-2xl sm:text-3xl font-bold text-[#165843] pr-4"></h2>
                        <button onclick="closeFullDropdown()" class="text-gray-500 hover:text-red-600 p-1 rounded-full bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <ul id="fullListContent" class="space-y-2 max-h-96 overflow-y-auto p-2">
                        <!-- List of entities goes here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- DATA STRUCTURES (Consolidated Global Scope) ---
        const CENTRAL_GOVT_SOURCES = ['MoP', 'MNRE', 'MoF', 'CEA', 'CERC', 'CTUIL', 'Grid India'];
        
        const ALL_STATES = [
            "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana",
            "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur",
            "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu",
            "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
        ];
        const ALL_UTS = [
            "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi",
            "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry"
        ];
        
        const STATE_SOURCES_MOCK = ['All States', 'Gujarat', 'Maharashtra', 'Karnataka', 'Tamil Nadu', 'Rajasthan', 'Uttar Pradesh'];
        const UT_SOURCES_MOCK = ['All UTs', 'Delhi', 'Jammu and Kashmir', 'Puducherry'];

        const COLUMNS = [
            { key: 'Central', label: 'Central', filters: CENTRAL_GOVT_SOURCES },
            { key: 'State', label: 'States', filters: STATE_SOURCES_MOCK }, // Using mock subset for column filter
            { key: 'UT', label: 'UTs', filters: UT_SOURCES_MOCK } // Using mock subset for column filter
        ];

        // Helper function to generate the flyout links dynamically
        function generateFlyoutLinks(entityList, type) {
            return entityList.map(entity => `
                <a href="?type=${type}&entity=${encodeURIComponent(entity)}" class="flyout-link">
                    ${entity}
                </a>
            `).join('');
        }

        // --- CORE APPLICATION LOGIC ---
        
        let ALL_POLICIES = [];
        let CURRENT_FILTERS = { Central: 'All', State: 'All', UT: 'All' };
        let SEARCH_QUERY = ''; 

        function generateMockPolicies() {
            const policies = [];
            const now = new Date();
            const mockTitles = [
                "New Tariff Policy for Solar Power Procurement Guidelines",
                "Details of Transmission Access Charge Waiver on Open Access",
                "CTUIL's Procedure for Inquiry in cases of Alleged Fraud",
                "Additional details as per Regulation 37.10(a) Compliance",
                "Draft Electricity (Metering) Rules, 2025 Consultation Paper",
                "Revised PPA Model for Renewable Energy Projects in Karnataka",
                "Maharashtra EV Policy 2024: Charging Infrastructure Subsidy",
                "Draft Regulation on Grid Connectivity of Renewable Energy Sources (Rajasthan)"
            ];
            const mockSummaries = [
                "Modifies conditions for accessing interstate transmission systems to promote green energy uptake.",
                "Provides clarity on new charges applicable to transmission access for solar and wind projects.",
                "Outlines the official process for investigating alleged fraud or transgressions in license applications.",
                "Specific compliance guidance related to regulatory procedures for major power stakeholders.",
                "Invites public comments and suggestions on proposed changes to electricity metering rules.",
                "Introduces revised contractual terms aimed at increasing viability for private renewable energy developers.",
                "Detailing incentives and financial support for deploying charging stations across the state of Maharashtra.",
                "Specific rules governing the connection of large-scale renewable projects to the regional grid."
            ];
            const mockSources = {
                Central: CENTRAL_GOVT_SOURCES,
                State: ALL_STATES,
                UT: ALL_UTS
            };

            let idCounter = 1;
            for (let i = 0; i < 30; i++) {
                const typeKey = i % 3 === 0 ? 'Central' : (i % 3 === 1 ? 'State' : 'UT');
                const sources = mockSources[typeKey];
                const randomSource = sources[Math.floor(Math.random() * sources.length)];
                const date = new Date(now.getTime() - Math.floor(Math.random() * 60 * 24 * 60 * 60 * 1000));
                
                policies.push({
                    id: `mock-${idCounter++}`,
                    title: mockTitles[idCounter % mockTitles.length],
                    summary: mockSummaries[idCounter % mockSummaries.length],
                    url: 'https://example.com/mock-policy',
                    source: randomSource,
                    source_type: typeKey,
                    publication_date: date,
                    dateString: `${date.getDate().toString().padStart(2, '0')} ${date.toLocaleString('default', { month: 'short' }).toUpperCase()}`
                });
            }
            return policies;
        }

        function updateClock() {
            const clockEl = document.getElementById('real-time-clock');
            if (clockEl) {
                const now = new Date();
                const options = { 
                    timeZone: 'Asia/Kolkata', 
                    day: '2-digit', month: 'short', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: false 
                };
                const formatter = new Intl.DateTimeFormat('en-GB', options);
                clockEl.textContent = `${formatter.format(now)} IST`;
            }
        }

        // --- NEW FUNCTION TO INSERT FLYOUT CONTENT AFTER LOAD ---
        function insertDropdownContent() {
            // Policies
            document.getElementById('central-policies-flyout').innerHTML = generateFlyoutLinks(CENTRAL_GOVT_SOURCES, 'Policy');
            document.getElementById('states-policies-flyout').innerHTML = generateFlyoutLinks(ALL_STATES, 'Policy');
            document.getElementById('uts-policies-flyout').innerHTML = generateFlyoutLinks(ALL_UTS, 'Policy');
            
            // Regulations
            document.getElementById('central-regulations-flyout').innerHTML = generateFlyoutLinks(CENTRAL_GOVT_SOURCES, 'Regulation');
            document.getElementById('states-regulations-flyout').innerHTML = generateFlyoutLinks(ALL_STATES, 'Regulation');
            document.getElementById('uts-regulations-flyout').innerHTML = generateFlyoutLinks(ALL_UTS, 'Regulation');
        }


        function initApp() {
            // 1. Initialize data and rendering
            ALL_POLICIES = generateMockPolicies();
            updateMonthTitle();
            renderDashboard();
            // startAutoScroll() is called inside renderDashboard
            
            // 2. Initialize real-time components
            updateClock();
            setInterval(updateClock, 1000); 

            // 3. FIX: Insert dropdown content now that all functions are defined
            insertDropdownContent();
        }

        function updateMonthTitle() {
            const monthTitleEl = document.getElementById('month-title');
            const currentMonthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            monthTitleEl.textContent = `Latest updates — ${currentMonthYear}`;
        }
        
        function handleSearch(query) {
            SEARCH_QUERY = query.toLowerCase();
            renderDashboard();
        }

        function handleFilterChange(columnKey, value) {
            CURRENT_FILTERS[columnKey] = value;
            renderDashboard();
        }

        function filterAndCategorizePolicies() {
            let searchFiltered = ALL_POLICIES.filter(policy => 
                policy.title.toLowerCase().includes(SEARCH_QUERY) || 
                policy.source.toLowerCase().includes(SEARCH_QUERY) ||
                (policy.summary || '').toLowerCase().includes(SEARCH_QUERY)
            );

            searchFiltered.sort((a, b) => b.publication_date.getTime() - a.publication_date.getTime());

            const categorized = { Central: [], State: [], UT: [] };

            searchFiltered.forEach(policy => {
                const type = policy.source_type;
                const specificFilter = CURRENT_FILTERS[type];
                
                if (categorized[type]) {
                    if (policy.source_type === type) {
                        if (specificFilter === 'All' || specificFilter === 'All States' || specificFilter === 'All UTs' || policy.source === specificFilter) {
                            categorized[type].push(policy);
                        }
                    }
                }
            });

            return categorized;
        }

        // --- RENDERING ---
        
        function renderDashboard() {
            const categorizedPolicies = filterAndCategorizePolicies();
            const gridEl = document.getElementById('policy-grid');
            gridEl.innerHTML = ''; // Clear existing content

            COLUMNS.forEach(column => {
                const columnPolicies = categorizedPolicies[column.key];
                
                const columnHtml = `
                    <div class="flex flex-col rounded-xl shadow-pro border border-gray-200 bg-gray-50 p-4">
                        <div class="mb-4 pb-2 border-b border-gray-300">
                            <h3 class="text-xl font-bold text-[#0F4237]">${column.label}</h3>
                        </div>
                        
                        <div class="mb-4">
                            <select 
                                class="w-full bg-white text-[#0F4237] text-base p-2 rounded-lg border border-gray-300 shadow-sm focus:ring-1 focus:ring-[#165843]"
                                onchange="handleFilterChange('${column.key}', this.value)"
                            >
                                <option value="All">All</option>
                                ${column.filters.filter(f => !f.startsWith('All')).map(source => `
                                    <option value="${source}" ${CURRENT_FILTERS[column.key] === source ? 'selected' : ''}>${source}</option>
                                `).join('')}
                            </select>
                        </div>

                        <div id="container-${column.key}" class="flex-grow space-y-4 policy-card-container p-1 -m-1">
                            ${columnPolicies.length === 0 ? 
                                `<div class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-pro">No updates found for ${column.label}.</div>` : 
                                columnPolicies.map(policy => `
                                    <div 
                                        class="policy-card bg-[#F7FBF9] p-4 rounded-xl shadow-sm border border-gray-200 transition-all duration-300 cursor-pointer flex space-x-3"
                                        onclick="openModal(event, '${policy.id}')"
                                    >
                                        <div class="flex-shrink-0 text-center bg-[#0F4237] text-white rounded-lg p-2 w-14 shadow-pro border border-gray-300">
                                            <div class="text-xl font-bold leading-none">${policy.dateString.split(' ')[0]}</div>
                                            <div class="text-xs uppercase leading-tight">${policy.dateString.split(' ')[1]}</div>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-base text-[#0F4237] mb-0.5 line-clamp-3 leading-snug">${policy.title}</h4>
                                            <p class="text-xs text-gray-500 line-clamp-1">${policy.summary || 'Click for details...'}</p>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
                gridEl.innerHTML += columnHtml;
            });
            // Re-run the auto-scroll setup after the HTML is rendered
            startAutoScroll();
        }

        // --- AUTO-SCROLL LOGIC (Floating Updates) ---
        function startAutoScroll() {
            // Find all containers after the dashboard has been rendered
            const containers = document.querySelectorAll('.policy-card-container');
            const scrollSpeed = 0.5; // Pixels per frame

            containers.forEach(container => {
                // Check if the container already has content
                if (!container.innerHTML.includes('policy-card')) return;
                
                // --- SETUP FOR CONTINUOUS SCROLL ---
                
                // 1. Save original content for duplication measurement
                const originalContent = container.innerHTML;
                
                // 2. Measure the height of the single content block
                // Temporarily place content in a hidden element to measure its scroll height accurately
                const tempDiv = document.createElement('div');
                tempDiv.style.visibility = 'hidden';
                tempDiv.style.position = 'absolute';
                tempDiv.innerHTML = originalContent;
                document.body.appendChild(tempDiv);
                
                const singleContentHeight = tempDiv.scrollHeight;
                document.body.removeChild(tempDiv); // Remove temporary element

                // Only proceed if scrolling is possible (content height > container height)
                if (singleContentHeight <= container.clientHeight) return;

                // 3. Duplicate the content inside the container
                // We clear and reinsert to simplify the DOM and ensure only two copies exist
                container.innerHTML = originalContent + originalContent;
                
                // --- ANIMATION LOOP ---
                // FIX: Removed pause event listeners entirely to ensure continuous flow.
                let scrollOffset = 0;
                
                // Set initial scroll offset to the start of the duplicated content for a clean loop initiation
                container.scrollTop = singleContentHeight;
                
                function scrollTick() {
                    // FIX: Changed to scroll downwards by subtracting from the offset
                    scrollOffset -= scrollSpeed;

                    // Check if the scroll offset exceeds the height of the original content (when scrolling down, the offset goes negative)
                    if (scrollOffset <= -singleContentHeight) {
                        // Snap the offset back to 0, creating the seamless loop
                        scrollOffset = 0;
                    }
                    
                    // We must calculate the scroll position from the bottom for negative offsets to work visually.
                    container.scrollTop = singleContentHeight + scrollOffset;
                    requestAnimationFrame(scrollTick); // Recurse for continuous animation
                }
                
                // Start the animation loop
                requestAnimationFrame(scrollTick);
            });
        }


        // --- MODAL LOGIC ---

        function openModal(event, policyId) {
            event.preventDefault();
            const policy = ALL_POLICIES.find(p => p.id === policyId);
            if (!policy) return;

            const modal = document.getElementById('policyModal');
            document.getElementById('modalTitle').textContent = policy.title;
            document.getElementById('modalSummary').textContent = policy.summary;
            document.getElementById('modalLink').href = policy.url;

            const metaHtml = `
                <span class="px-3 py-1 rounded-full text-xs font-medium text-white 
                    ${policy.source_type === 'Central' ? 'bg-[#165843]' : (policy.source_type === 'State' ? 'bg-green-600' : 'bg-blue-600')}"
                >${policy.source_type} (${policy.source})</span>
                <span>Published: ${policy.publication_date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
            `;
            document.getElementById('modalMeta').innerHTML = metaHtml;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('policyModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- NEW FULL DROPDOWN MODAL LOGIC (Level 3 Resolver) ---
        // This is now redundant since the nested hover menu works, but we keep the close logic.
        function openFullDropdown(event, title, entityList) {
            event.preventDefault();
            const modal = document.getElementById('fullListModal');
            document.getElementById('fullListTitle').textContent = title;
            const content = document.getElementById('fullListContent');
            content.innerHTML = '';
            
            // Generate list items
            const listHtml = entityList.map(entity => {
                // Determine the correct policy/regulation type from the title (e.g., 'Central Policies')
                const type = title.includes('Policy') ? 'Policy' : 'Regulation'; 
                // Create a generic link for now; in the final system, this would point to a filtered page/route.
                const href = `?type=${type}&entity=${encodeURIComponent(entity)}`;
                
                return `
                    <li>
                        <a href="${href}" class="dropdown-link text-left hover:text-white hover:bg-[#165843] rounded-md transition-colors duration-200">
                            ${entity}
                        </a>
                    </li>
                `;
            }).join('');

            content.innerHTML = `<ul class="space-y-1">${listHtml}</ul>`;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeFullDropdown() {
            const modal = document.getElementById('fullListModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- INITIALIZATION ---
        window.onload = initApp;

    </script>
</body>
</html>
